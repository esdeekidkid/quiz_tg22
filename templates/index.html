<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Quiz Helper</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Quiz Helper</h1>

        <div class="section">
            <h2>1. Загрузить PDF с лекцией</h2>
            <form id="upload-pdf-form">
                <label for="pdf-file">Выберите PDF файл:</label>
                <input type="file" id="pdf-file" name="pdf" accept=".pdf" required>
                <button type="submit">Загрузить PDF</button>
            </form>
            <div id="status-pdf"></div>
        </div>

        <div class="section">
            <h2>2. Вставить HTML теста</h2>
            <label for="quiz-html">HTML теста (весь код страницы):</label>
            <textarea id="quiz-html" rows="10" placeholder="Вставьте HTML код теста сюда..."></textarea>
            <button id="parse-btn" onclick="parseQuiz()">Разобрать HTML</button>
            <div id="status-quiz-parse"></div>
        </div>

        <div class="section">
            <h2>3. Результаты парсинга (вопросы)</h2>
            <div id="parsed-questions-container">
                <p>Здесь появятся вопросы после разбора HTML.</p>
                <div id="parsed-questions" style="display: none;"></div>
                <button id="process-parsed-btn" onclick="processParsedQuiz()" style="display: none;">Сопоставить с лекцией</button>
            </div>
        </div>

        <div class="section">
            <h2>4. Результаты сопоставления</h2>
            <div id="results">Здесь появятся результаты после сопоставления с лекцией.</div>
        </div>
    </div>

    <script>
        let lectureText = null; // Хранит текст лекции после загрузки PDF
        let parsedQuestions = null; // Хранит вопросы после парсинга

        document.getElementById('upload-pdf-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const statusDiv = document.getElementById('status-pdf');
            statusDiv.className = '';
            statusDiv.textContent = 'Загрузка...';

            const formData = new FormData();
            const fileInput = document.getElementById('pdf-file');
            if (!fileInput.files[0]) {
                statusDiv.className = 'error';
                statusDiv.textContent = 'Ошибка: файл не выбран.';
                return;
            }
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/api/extract-text-from-pdf/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) {
                    let errorMsg = 'Неизвестная ошибка сервера при загрузке PDF';
                    if (data && typeof data === 'object' && data.detail) {
                        if (typeof data.detail === 'string') {
                            errorMsg = data.detail;
                        } else {
                            try {
                                errorMsg = JSON.stringify(data.detail);
                            } catch (e) {
                                errorMsg = String(data.detail);
                            }
                        }
                    } else if (response.statusText) {
                        errorMsg = response.statusText;
                    }
                    throw new Error(errorMsg);
                }

                lectureText = data.text;
                statusDiv.className = 'success';
                statusDiv.textContent = `PDF загружен. Длина: ${data.length} символов. Сниппет: "${data.snippet.substring(0, 100)}${data.snippet.length > 100 ? '...' : ''}"`;

            } catch (error) {
                statusDiv.className = 'error';
                let errorMessage = error.message;
                if (typeof error.message === 'object') {
                    try {
                        errorMessage = JSON.stringify(error.message);
                    } catch (e) {
                        errorMessage = String(error.message);
                    }
                }
                statusDiv.textContent = `Ошибка загрузки: ${errorMessage}`;
            }
        });

        async function parseQuiz() {
            const statusDiv = document.getElementById('status-quiz-parse');
            statusDiv.className = '';
            statusDiv.textContent = 'Разбор...';
            const parsedQuestionsDiv = document.getElementById('parsed-questions');
            const processParsedBtn = document.getElementById('process-parsed-btn');

            const html = document.getElementById('quiz-html').value.trim();
            if (!html) {
                statusDiv.className = 'error';
                statusDiv.textContent = 'Ошибка: введите HTML теста.';
                return;
            }

            try {
                const response = await fetch('/api/parse-quiz-html/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ html: html })
                });

                const data = await response.json();
                if (!response.ok) {
                    let errorMsg = 'Неизвестная ошибка сервера при разборе HTML';
                    if (data && typeof data === 'object' && data.detail) {
                        if (typeof data.detail === 'string') {
                            errorMsg = data.detail;
                        } else {
                            try {
                                errorMsg = JSON.stringify(data.detail);
                            } catch (e) {
                                errorMsg = String(data.detail);
                            }
                        }
                    } else if (response.statusText) {
                        errorMsg = response.statusText;
                    }
                    throw new Error(errorMsg);
                }

                parsedQuestions = data.questions;
                statusDiv.className = 'success';
                statusDiv.textContent = `Найдено ${parsedQuestions.length} вопросов.`;

                // Отобразить вопросы
                parsedQuestionsDiv.innerHTML = '';
                parsedQuestions.forEach((q, index) => {
                    const qDiv = document.createElement('div');
                    qDiv.className = 'parsed-question';
                    qDiv.innerHTML = `
                        <h4>Вопрос ${index + 1}:</h4>
                        <p><strong>Текст:</strong> ${q.question}</p>
                        <p><strong>Тип:</strong> ${q.is_short ? 'Короткий ответ' : 'Множественный выбор'}</p>
                        <p><strong>Опции:</strong> ${q.options.join(', ')}</p>
                        <hr>
                    `;
                    parsedQuestionsDiv.appendChild(qDiv);
                });
                parsedQuestionsDiv.style.display = 'block';
                processParsedBtn.style.display = 'inline-block';

            } catch (error) {
                statusDiv.className = 'error';
                let errorMessage = error.message;
                if (typeof error.message === 'object') {
                    try {
                        errorMessage = JSON.stringify(error.message);
                    } catch (e) {
                        errorMessage = String(error.message);
                    }
                }
                statusDiv.textContent = `Ошибка разбора: ${errorMessage}`;
                parsedQuestionsDiv.style.display = 'none';
                processParsedBtn.style.display = 'none';
            }
        }

        async function processParsedQuiz() {
            const statusDiv = document.getElementById('status-quiz-parse');
            statusDiv.className = '';
            statusDiv.textContent = 'Сопоставление...';
            const resultsDiv = document.getElementById('results');

            if (!lectureText) {
                statusDiv.className = 'error';
                statusDiv.textContent = 'Ошибка: сначала загрузите PDF.';
                resultsDiv.textContent = 'Сначала загрузите PDF.';
                return;
            }

            if (!parsedQuestions || parsedQuestions.length === 0) {
                statusDiv.className = 'error';
                statusDiv.textContent = 'Ошибка: сначала разберите HTML.';
                resultsDiv.textContent = 'Сначала разберите HTML.';
                return;
            }

            try {
                const response = await fetch('/api/process-quiz/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questions: parsedQuestions, lecture_text: lectureText })
                });

                const data = await response.json();
                if (!response.ok) {
                    let errorMsg = 'Неизвестная ошибка сервера при обработке вопросов';
                    if (data && typeof data === 'object' && data.detail) {
                        if (typeof data.detail === 'string') {
                            errorMsg = data.detail;
                        } else {
                            try {
                                errorMsg = JSON.stringify(data.detail);
                            } catch (e) {
                                errorMsg = String(data.detail);
                            }
                        }
                    } else if (response.statusText) {
                        errorMsg = response.statusText;
                    }
                    throw new Error(errorMsg);
                }

                statusDiv.className = 'success';
                statusDiv.textContent = 'Вопросы сопоставлены успешно!';
                displayResults(data.results); // Вызов новой функции для отображения результатов

            } catch (error) {
                statusDiv.className = 'error';
                let errorMessage = error.message;
                if (typeof error.message === 'object') {
                    try {
                        errorMessage = JSON.stringify(error.message);
                    } catch (e) {
                        errorMessage = String(error.message);
                    }
                }
                statusDiv.textContent = `Ошибка сопоставления: ${errorMessage}`;
                resultsDiv.textContent = `Ошибка: ${errorMessage}`;
            }
        }

        // --- НОВАЯ ФУНКЦИЯ ДЛЯ ОТОБРАЖЕНИЯ РЕЗУЛЬТАТОВ ---
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = ''; // Очистить предыдущие результаты

            if (!results || results.length === 0) {
                resultsDiv.textContent = 'Результаты не найдены.';
                return;
            }

            results.forEach((result, index) => {
                // Создать контейнер для вопроса
                const questionBlock = document.createElement('div');
                questionBlock.className = 'question-result-block';

                // Заголовок вопроса
                const questionHeader = document.createElement('h3');
                questionHeader.textContent = `Вопрос ${index + 1}: ${result.question}`;
                questionBlock.appendChild(questionHeader);

                // Тип вопроса (опционально)
                if (result.type) {
                    const typeSpan = document.createElement('span');
                    typeSpan.className = 'question-type';
                    typeSpan.textContent = ` (Тип: ${result.type})`;
                    questionHeader.appendChild(typeSpan);
                }

                // Создать список для опций
                const optionsList = document.createElement('ul');
                optionsList.className = 'options-list';

                // Обработка опций (если они есть)
                if (result.options && Array.isArray(result.options)) {
                    result.options.forEach(optObj => {
                        const listItem = document.createElement('li');
                        listItem.className = 'option-item';

                        // Текст опции
                        const optionText = document.createElement('span');
                        optionText.className = 'option-text';
                        optionText.textContent = optObj.option;

                        // Нормализованный балл (для понимания важности)
                        const scoreBadge = document.createElement('span');
                        scoreBadge.className = 'score-badge';
                        scoreBadge.textContent = `(${optObj.norm.toFixed(3)})`;

                        // Контейнер для текста и бейджа
                        const textContainer = document.createElement('div');
                        textContainer.appendChild(optionText);
                        textContainer.appendChild(scoreBadge);

                        listItem.appendChild(textContainer);

                        // Проверить, является ли этот вариант выбранным (правильным)
                        const isSelected = result.selected.some(selOpt => selOpt.option === optObj.option);

                        if (isSelected) {
                            // Если вариант выбран, добавить класс для подсветки
                            listItem.classList.add('selected-option');
                            // Добавить обработчик клика для отображения сниппетов
                            listItem.addEventListener('click', () => {
                                toggleSnippets(listItem, optObj.snippets); // Вызов функции для переключения сниппетов
                            });
                        }

                        optionsList.appendChild(listItem);
                    });
                } else {
                    // Если опции не переданы (например, для коротких ответов)
                    const infoItem = document.createElement('li');
                    infoItem.className = 'info-item';
                    if (result.type === 'short' && result.answer) {
                        infoItem.innerHTML = `<strong>Ответ:</strong> ${result.answer}`;
                        if (result.excerpt) {
                            infoItem.innerHTML += `<br><strong>Сниппет:</strong> ${result.excerpt}`;
                        }
                    } else {
                        infoItem.textContent = 'Нет доступных вариантов для отображения.';
                    }
                    optionsList.appendChild(infoItem);
                }

                questionBlock.appendChild(optionsList);
                resultsDiv.appendChild(questionBlock);
            });
        }

        // --- ФУНКЦИЯ ДЛЯ ПЕРЕКЛЮЧЕНИЯ ОТРАЖЕНИЯ СНИППЕТОВ ---
        function toggleSnippets(optionElement, snippets) {
            // Найти существующий блок сниппетов для этого элемента
            let snippetsDiv = optionElement.querySelector('.snippets-container');

            if (snippetsDiv) {
                // Если блок существует, переключить его видимость
                if (snippetsDiv.style.display === 'none' || !snippetsDiv.style.display) {
                    snippetsDiv.style.display = 'block';
                } else {
                    snippetsDiv.style.display = 'none';
                }
            } else {
                // Если блока нет, создать его и добавить к элементу опции
                snippetsDiv = document.createElement('div');
                snippetsDiv.className = 'snippets-container';

                if (snippets && Array.isArray(snippets) && snippets.length > 0) {
                    // Отобразить наиболее релевантные сниппеты (например, первые 2)
                    const topSnippets = snippets.slice(0, 2);
                    topSnippets.forEach(snippetObj => {
                        const snippetElement = document.createElement('p');
                        snippetElement.className = 'snippet-text';
                        // Показываем причину и сниппет
                        snippetElement.textContent = `${snippetObj.why ? snippetObj.why + ': ' : ''}${snippetObj.excerpt || snippetObj.matched || 'N/A'}`;
                        snippetsDiv.appendChild(snippetElement);
                    });
                } else {
                    // Если сниппетов нет
                    const noSnippets = document.createElement('p');
                    noSnippets.className = 'snippet-text';
                    noSnippets.textContent = 'Сниппеты не найдены.';
                    snippetsDiv.appendChild(noSnippets);
                }

                optionElement.appendChild(snippetsDiv);
            }
        }

    </script>
</body>
</html>
