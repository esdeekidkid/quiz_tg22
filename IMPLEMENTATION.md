# Quiz Helper - Оптимизированная реализация для Render Free (512 МБ RAM)

## ✅ Завершено: Полная оптимизация под ограничения памяти

### Архитектура решения

#### 1. Бэкенд (Python + FastAPI)
- **Основной файл**: `main.py` (~19KB)
- **Порты**: 
  - API endpoints на /api/*
  - Статические файлы через FastAPI
  
**Оптимизация памяти**:
- ✅ Глобальное хранилище SESSION_STORAGE удалено
- ✅ Все данные хранятся в Supabase (quiz_sessions, quiz_results)
- ✅ score_option_by_lecture() возвращает только best_snippet вместо массива
- ✅ Размер фрагментов ограничен 500 символами
- ✅ Размер PDF ограничен 10 МБ
- ✅ LRU кэш для нормализованного текста (maxsize=10)
- ✅ Gunicorn с 1 рабочим процессом (минимум памяти)

#### 2. Фронтенд (HTML + CSS + JavaScript)
- **HTML**: `templates/index.html` (~11KB)
  - Встроенный modal используя `<dialog>` элемент
  - Минимальный JavaScript без фреймворков
  
- **CSS**: `static/style.css` (~6KB)
  - Зеленая подсветка правильных ответов (#d4edda)
  - Адаптивная верстка
  - Встроенные стили (нет дополнительных загрузок)

- **JavaScript**: Встроен в HTML
  - Переменные: sessionId, parsedQuestions (максимум ~1-2 МБ в памяти браузера)
  - Event-driven рендеринг без накопления данных
  - Функции: parseQuiz(), processParsedQuiz(), renderResults(), showSnippet()

#### 3. Суперпаблико хранилище (Supabase)
- **Таблица quiz_sessions**:
  - session_id (text, unique) - генерируется при загрузке PDF
  - lecture_text (text) - полный текст лекции
  - expires_at - TTL 24 часа для автоматической очистки
  
- **Таблица quiz_results**:
  - session_id (FK) - связь с сессией
  - results_json (jsonb) - результаты обработки
  - expires_at - TTL 24 часа

#### 4. Edge Functions (Deno TypeScript)
- **quiz_storage** - основной обработчик операций БД
  - Действия: save_session, get_session, save_results
  - Использует Supabase JS client для безопасной работы
  - Все CORS заголовки настроены правильно

### Поток данных

```
1. Пользователь загружает PDF
   ↓ POST /api/extract-text-from-pdf/
   ↓ Генерируется sessionId (UUID)
   ↓ Текст лекции сохраняется в quiz_sessions через Edge Function
   ↓ Браузер получает sessionId

2. Пользователь вставляет HTML теста и нажимает "Разобрать HTML"
   ↓ POST /api/parse-quiz-html/
   ↓ BeautifulSoup парсит HTML
   ↓ Возвращается массив вопросов (остается в памяти браузера)

3. Пользователь нажимает "Сопоставить с лекцией"
   ↓ POST /api/process-quiz/ { questions, session_id }
   ↓ Бэкенд достает lecture_text из Supabase по sessionId
   ↓ Для каждого вопроса вычисляется score и best_snippet
   ↓ Правильные ответы отмечаются (is_correct: true/false)
   ↓ Результаты сохраняются в quiz_results через Edge Function
   ↓ Браузер получает результаты и рендерит их

4. Пользователь кликает на ответ
   ↓ Открывается modal с best_snippet (фрагмент лекции)
   ↓ Зеленая подсветка для правильных ответов
```

### Ожидаемое использование памяти

| Компонент | Память |
|-----------|--------|
| Python runtime | ~100 МБ |
| FastAPI + зависимости | ~50 МБ |
| Буферы для PDF/текста (0-5 МБ) | ~30 МБ |
| LRU кэши | ~20 МБ |
| Gunicorn overhead | ~20 МБ |
| **Итого** | **<220 МБ** |
| **Запас для Render Free** | **~290 МБ** |

### Развертывание на Render

1. **Procfile настроен**:
   ```
   web: gunicorn -w 1 -k uvicorn.workers.UvicornWorker --max-requests 100 --max-requests-jitter 10 main:app
   ```
   - 1 рабочий процесс (минимум)
   - Max requests 100 для graceful shutdown
   - Jitter 10 для распределения нагрузки

2. **Environment переменные**:
   - VITE_SUPABASE_URL (автоматически)
   - VITE_SUPABASE_ANON_KEY (автоматически)

3. **Зависимости** в `requirements.txt`:
   ```
   fastapi==0.115.0
   uvicorn[standard]==0.32.0
   gunicorn==23.0.0
   pdfplumber==0.11.4
   beautifulsoup4==4.12.3
   jinja2==3.1.4
   python-multipart==0.0.17
   httpx==0.27.0
   ```

### Функции и особенности

✅ **Множественный выбор**
- Отображение всех опций
- Зеленая подсветка правильных ответов
- Клик на опцию открывает modal с подтверждающим фрагментом

✅ **Открытые вопросы (short)**
- Найденный ответ выделен зеленым
- Кнопка "Показать фрагмент" для вывода подтверждения

✅ **Modal окно**
- Использует встроенный `<dialog>` элемент (нет библиотек)
- Закрывается кнопкой X или кликом вне окна
- Скроллируемое содержимое для длинных фрагментов

✅ **Оптимизация**
- Фрагменты ограничены 500 символами
- Хранение только лучшего совпадения (best_snippet)
- Event delegation вместо множественных обработчиков
- Кэширование нормализованного текста

### Ограничения и преимущества

**Ограничения**:
- Максимальный размер PDF: 10 МБ
- Максимальное количество вопросов: теоретически неограниченно
- TTL сессий: 24 часа (автоматическая очистка)

**Преимущества**:
- Масштабируемость: данные в Supabase, а не в памяти приложения
- Надежность: автоматическое восстановление после сбоя
- Производительность: быстрые операции через Edge Functions
- Экономность: <220 МБ RAM на Render Free

### Тестирование

1. Загрузить PDF (любой размер < 10 МБ)
2. Вставить HTML теста из Moodle
3. Нажать "Разобрать HTML"
4. Нажать "Сопоставить с лекцией"
5. Проверить результаты с зеленой подсветкой
6. Кликнуть на ответ и просмотреть фрагмент в modal

---

**Статус**: ✅ Готово к развертыванию на Render Free
**Дата**: 2025-11-27
**Версия**: 1.0
